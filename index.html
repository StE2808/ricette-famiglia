<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Ricette di Famiglia</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>üìñ Editor Ricette di Famiglia</h1>
        <div class="header-controls">
            <span id="counter" class="counter">0/0 verificate</span>
            <button id="export-btn" class="btn-export">üíæ Esporta JSON</button>
        </div>
    </header>

    <main class="editor-layout">
        <!-- Colonna sinistra: Immagini -->
        <section class="image-panel">
            <div id="image-container" class="image-container">
                <p class="placeholder">Nessuna immagine disponibile</p>
            </div>
        </section>

        <!-- Colonna destra: Editor -->
        <section class="editor-panel">
            <div class="recipe-header">
                <h2 id="recipe-title">Caricamento...</h2>
                <label class="verificato-label">
                    <input type="checkbox" id="verificato-checkbox">
                    <span>Verificato</span>
                </label>
            </div>

            <textarea id="markdown-editor" placeholder="Contenuto markdown della ricetta..."></textarea>

            <div class="editor-controls">
                <button id="prev-btn" class="btn-nav" disabled>‚Üê Precedente</button>
                <span id="recipe-position" class="position">1/1</span>
                <button id="next-btn" class="btn-nav">Successiva ‚Üí</button>
            </div>
        </section>
    </main>

    <!-- Sezione Impostazioni GitHub (collapsible) -->
    <details class="github-settings">
        <summary>‚öôÔ∏è Impostazioni GitHub</summary>
        <div class="settings-content">
            <p class="settings-info">Configura il salvataggio automatico su GitHub. <a href="#come-ottenere-token" onclick="alert('Vai su github.com ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens ‚Üí Tokens (classic) ‚Üí Generate new token ‚Üí Scope: repo')">Come ottenere il token?</a></p>

            <div class="form-group">
                <label for="github-username">GitHub Username</label>
                <input type="text" id="github-username" placeholder="es: StE2808">
            </div>

            <div class="form-group">
                <label for="github-repo">Repository Name</label>
                <input type="text" id="github-repo" placeholder="ricette-famiglia" value="ricette-famiglia">
            </div>

            <div class="form-group">
                <label for="github-token">Personal Access Token</label>
                <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx">
            </div>

            <button id="save-settings-btn" class="btn-save-settings">üíæ Salva impostazioni</button>
            <span id="settings-status" class="settings-status"></span>
        </div>
    </details>

    <!-- Modal per esportazione JSON -->
    <div id="export-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Esporta ricette.json</h3>
                <button id="close-modal" class="close-btn">&times;</button>
            </div>
            <p class="modal-info">Copia il contenuto qui sotto e incollalo in <code>data/ricette.json</code></p>
            <textarea id="json-output" readonly></textarea>
            <div class="modal-footer">
                <button id="copy-btn" class="btn-copy">üìã Copia negli appunti</button>
                <button id="download-btn" class="btn-download">üíæ Scarica file</button>
            </div>
        </div>
    </div>

    <script>
        // Stato dell'applicazione
        let ricette = [];
        let indiceCorrente = 0;

        // Elementi DOM
        const imageContainer = document.getElementById('image-container');
        const recipeTitle = document.getElementById('recipe-title');
        const markdownEditor = document.getElementById('markdown-editor');
        const verificatoCheckbox = document.getElementById('verificato-checkbox');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const recipePosition = document.getElementById('recipe-position');
        const counter = document.getElementById('counter');
        const exportBtn = document.getElementById('export-btn');
        const exportModal = document.getElementById('export-modal');
        const closeModal = document.getElementById('close-modal');
        const jsonOutput = document.getElementById('json-output');
        const copyBtn = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn');

        // Elementi GitHub settings
        const githubUsername = document.getElementById('github-username');
        const githubRepo = document.getElementById('github-repo');
        const githubToken = document.getElementById('github-token');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const settingsStatus = document.getElementById('settings-status');

        // Carica ricette dal JSON
        async function caricaRicette() {
            try {
                const response = await fetch('data/ricette.json');
                ricette = await response.json();
                mostraRicetta(0);
                aggiornaContatore();
            } catch (error) {
                console.error('Errore nel caricamento delle ricette:', error);
                recipeTitle.textContent = 'Errore nel caricamento';
            }
        }

        // Mostra ricetta corrente
        function mostraRicetta(indice) {
            if (indice < 0 || indice >= ricette.length) return;

            // Salva modifiche ricetta precedente prima di cambiare
            if (indiceCorrente !== indice) {
                salvaRicettaCorrente();
            }

            indiceCorrente = indice;
            const ricetta = ricette[indice];

            // Aggiorna titolo
            recipeTitle.textContent = ricetta.titolo;

            // Aggiorna immagini
            if (ricetta.immagini && ricetta.immagini.length > 0) {
                imageContainer.innerHTML = ricetta.immagini.map(img => `
                    <div class="image-wrapper">
                        <img src="immagini/${img}" alt="${ricetta.titolo}" onclick="zoomImmagine(this)">
                    </div>
                `).join('');
            } else {
                imageContainer.innerHTML = '<p class="placeholder">Nessuna immagine disponibile</p>';
            }

            // Aggiorna editor
            markdownEditor.value = ricetta.markdown;

            // Aggiorna checkbox verificato
            verificatoCheckbox.checked = ricetta.verificato;

            // Aggiorna navigazione
            prevBtn.disabled = indice === 0;
            nextBtn.disabled = indice === ricette.length - 1;
            recipePosition.textContent = `${indice + 1}/${ricette.length}`;
        }

        // Salva modifiche ricetta corrente
        function salvaRicettaCorrente() {
            if (ricette.length === 0) return;

            ricette[indiceCorrente].markdown = markdownEditor.value;
            ricette[indiceCorrente].verificato = verificatoCheckbox.checked;
            aggiornaContatore();
        }

        // Aggiorna contatore ricette verificate
        function aggiornaContatore() {
            const verificate = ricette.filter(r => r.verificato).length;
            counter.textContent = `${verificate}/${ricette.length} verificate`;
        }

        // Zoom immagine (modal semplice)
        function zoomImmagine(img) {
            const modal = document.createElement('div');
            modal.className = 'image-modal';
            modal.innerHTML = `<img src="${img.src}" alt="${img.alt}">`;
            modal.onclick = () => modal.remove();
            document.body.appendChild(modal);
        }

        // === GESTIONE IMPOSTAZIONI GITHUB ===

        // Carica impostazioni GitHub da localStorage
        function caricaImpostazioniGitHub() {
            const username = localStorage.getItem('github_username') || '';
            const repo = localStorage.getItem('github_repo') || 'ricette-famiglia';
            const token = localStorage.getItem('github_token') || '';

            // Popola i campi del form
            if (githubUsername) githubUsername.value = username;
            if (githubRepo) githubRepo.value = repo;
            if (githubToken) githubToken.value = token;

            return { username, repo, token };
        }

        // Salva impostazioni GitHub in localStorage
        function salvaImpostazioniGitHub() {
            const username = githubUsername.value.trim();
            const repo = githubRepo.value.trim();
            const token = githubToken.value.trim();

            if (!username || !repo || !token) {
                settingsStatus.textContent = '‚ùå Compila tutti i campi';
                settingsStatus.className = 'settings-status error';
                return;
            }

            localStorage.setItem('github_username', username);
            localStorage.setItem('github_repo', repo);
            localStorage.setItem('github_token', token);

            settingsStatus.textContent = '‚úÖ Impostazioni salvate!';
            settingsStatus.className = 'settings-status success';

            setTimeout(() => {
                settingsStatus.textContent = '';
            }, 3000);
        }

        // Salva su GitHub tramite API
        async function salvasuGitHub(jsonContent, settings) {
            const { username, repo, token } = settings;
            const path = 'data/ricette.json';
            const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;

            // Step 1: GET per ottenere lo SHA corrente del file
            let sha = null;
            try {
                const getResponse = await fetch(apiUrl, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (getResponse.ok) {
                    const data = await getResponse.json();
                    sha = data.sha;
                } else if (getResponse.status === 404) {
                    // File non esiste ancora, SHA non necessario
                    sha = null;
                } else {
                    throw new Error(`GET fallito: ${getResponse.status} ${getResponse.statusText}`);
                }
            } catch (error) {
                throw new Error(`Impossibile ottenere SHA: ${error.message}`);
            }

            // Step 2: PUT per aggiornare/creare il file
            const content = btoa(unescape(encodeURIComponent(jsonContent))); // Converti in base64
            const verificate = ricette.filter(r => r.verificato).length;
            const message = `Aggiornamento ricette (${verificate}/${ricette.length} verificate)`;

            const body = {
                message: message,
                content: content
            };

            // Aggiungi SHA solo se il file esiste gi√†
            if (sha) {
                body.sha = sha;
            }

            const putResponse = await fetch(apiUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(body)
            });

            if (!putResponse.ok) {
                const errorData = await putResponse.json().catch(() => ({}));
                throw new Error(`PUT fallito: ${putResponse.status} - ${errorData.message || putResponse.statusText}`);
            }

            return await putResponse.json();
        }

        // Esporta JSON
        async function esportaJSON() {
            salvaRicettaCorrente(); // Salva eventuali modifiche pendenti
            const jsonString = JSON.stringify(ricette, null, 2);

            // Controlla se c'√® un token GitHub configurato
            const settings = caricaImpostazioniGitHub();
            if (settings.token && settings.username && settings.repo) {
                // Salva su GitHub
                exportBtn.disabled = true;
                exportBtn.textContent = '‚è≥ Salvataggio su GitHub...';

                try {
                    await salvasuGitHub(jsonString, settings);
                    exportBtn.textContent = '‚úÖ Salvato su GitHub!';
                    setTimeout(() => {
                        exportBtn.textContent = 'üíæ Esporta JSON';
                        exportBtn.disabled = false;
                    }, 3000);
                } catch (error) {
                    console.error('Errore GitHub:', error);
                    exportBtn.textContent = '‚ùå Errore GitHub';
                    setTimeout(() => {
                        exportBtn.textContent = 'üíæ Esporta JSON';
                        exportBtn.disabled = false;
                    }, 3000);

                    // Mostra modal manuale come fallback
                    if (confirm('Errore nel salvataggio su GitHub: ' + error.message + '\n\nVuoi usare il metodo di esportazione manuale?')) {
                        jsonOutput.value = jsonString;
                        exportModal.classList.add('show');
                    }
                }
            } else {
                // Comportamento normale: mostra modal
                jsonOutput.value = jsonString;
                exportModal.classList.add('show');
            }
        }

        // Copia JSON negli appunti
        async function copiaJSON() {
            try {
                await navigator.clipboard.writeText(jsonOutput.value);
                copyBtn.textContent = '‚úì Copiato!';
                setTimeout(() => {
                    copyBtn.textContent = 'üìã Copia negli appunti';
                }, 2000);
            } catch (error) {
                alert('Errore nella copia. Seleziona manualmente il testo.');
            }
        }

        // Scarica JSON come file
        function scaricaJSON() {
            const blob = new Blob([jsonOutput.value], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ricette.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event listeners
        prevBtn.addEventListener('click', () => mostraRicetta(indiceCorrente - 1));
        nextBtn.addEventListener('click', () => mostraRicetta(indiceCorrente + 1));
        verificatoCheckbox.addEventListener('change', () => {
            ricette[indiceCorrente].verificato = verificatoCheckbox.checked;
            aggiornaContatore();
        });
        markdownEditor.addEventListener('input', () => {
            ricette[indiceCorrente].markdown = markdownEditor.value;
        });
        exportBtn.addEventListener('click', esportaJSON);
        closeModal.addEventListener('click', () => exportModal.classList.remove('show'));
        copyBtn.addEventListener('click', copiaJSON);
        downloadBtn.addEventListener('click', scaricaJSON);
        saveSettingsBtn.addEventListener('click', salvaImpostazioniGitHub);

        // Chiudi modal cliccando fuori
        exportModal.addEventListener('click', (e) => {
            if (e.target === exportModal) {
                exportModal.classList.remove('show');
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Alt+‚Üê per ricetta precedente
            if (e.altKey && e.key === 'ArrowLeft' && !prevBtn.disabled) {
                mostraRicetta(indiceCorrente - 1);
            }
            // Alt+‚Üí per ricetta successiva
            if (e.altKey && e.key === 'ArrowRight' && !nextBtn.disabled) {
                mostraRicetta(indiceCorrente + 1);
            }
            // Alt+V per toggle verificato
            if (e.altKey && e.key === 'v') {
                verificatoCheckbox.checked = !verificatoCheckbox.checked;
                verificatoCheckbox.dispatchEvent(new Event('change'));
            }
            // Alt+E per esportare
            if (e.altKey && e.key === 'e') {
                e.preventDefault();
                esportaJSON();
            }
        });

        // Salva prima di chiudere la pagina
        window.addEventListener('beforeunload', (e) => {
            salvaRicettaCorrente();
            // Note: il JSON viene salvato solo in memoria, non su disco
            // L'utente deve esportare manualmente
        });

        // Inizializzazione
        caricaRicette();
        caricaImpostazioniGitHub();
    </script>
</body>
</html>
